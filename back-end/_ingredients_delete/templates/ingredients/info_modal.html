<div class="modal fade modal-lg ingredient-modal" id="modal-{{ ingredient.id }}" tabindex="-1"
  aria-labelledby="modal-{{ ingredient.id }}-title" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body row">
        <div class="col-auto versions">
          <h2 id="modal-{{ ingredient.id }}-title" class="ingredient-title selected"
            onclick="load_info_panel(event)"
            ingredient-id="{{ ingredient.id }}">
            {{ ingredient }}
          </h2>
          <p class="versions-title">Verzie</p>
          <hr>
          <!-- loop over them 3 times -->
          <div class="version-buttons">
            {% for version in ingredient.versions.all %}
            <p class="version-button {{ version.status }}" version="{{ version.version_number }}"
              onclick="load_info_panel(event)"
              url="{% url 'ingredients:ingredient_version_info' ingredient_version_id=version.id %}"
              version-id="{{ version.id }}">
              {{ version }}
            </p>
            {% endfor %}
          </div>
          <button class="btn success-light-button add-version-button" onclick="load_info_panel(event)"
            url="{% url 'ingredients:new_ingredient_version' ingredient_id=ingredient.id %}">
            Pridať verziu
          </button>
        </div>
        <div class="col info">
          {% include 'ingredients/ingredient_info.html' with ingredient=ingredient only %}
        </div>
      </div>
    </div>
  </div>
</div>
</div>
<!-- Order the versions -->
<script>
  function sort_versions() {
    $("#modal-{{ ingredient.id }} .version-button").sort(function (a, b) {
      var classA = $(a);
      var classB = $(b);
      var versionA = $(a).data("version");
      var versionB = $(b).data("version");
      if (classA.hasClass("inactive") && classB.hasClass("inactive")) {
        return versionB - versionA;
      } else if (classA.hasClass("inactive")) {
        return -1;
      } else if (classB.hasClass("inactive")) {
        return 1;
      } else if (classA.hasClass("active") && classB.hasClass("active")) {
        return versionB - versionA;
      } else if (classA.hasClass("active")) {
        return -1;
      } else if (classB.hasClass("active")) {
        return 1;
      } else if (classA.hasClass("deleted") && classB.hasClass("deleted")) {
        return versionB - versionA;
      } else if (classA.hasClass("deleted")) {
        return -1;
      } else {
        return 1;
      }
    }).appendTo("#modal-{{ ingredient.id }} .version-buttons");
  }
  sort_versions();
</script>
<!-- Add script to load info panel -->
<script>
  function load_info_panel(event) {
    // Fetch version info from the url in the event target
    // and load it into the version-info div

    let info_div = event.target.closest('.ingredient-modal').querySelector('.info');
    let versions_div = event.target.closest('.ingredient-modal').querySelector('.versions');

    let ingredient_id = event.target.getAttribute('ingredient-id');
    let version_id = event.target.getAttribute('version-id');

    

    if (ingredient_id){
        var show_info_div = info_div.querySelector(`.ingredient-info-${ingredient_id}`)
    } else if (version_id 
      && info_div.querySelector(`.ingredient-version-info-${version_id}`)){
        var show_info_div = info_div.querySelector(`.ingredient-version-info-${version_id}`)
    } else if ($(event.target).hasClass('add-version-button')){
      $(info_div).find('.form').remove()
    }
    
    if (show_info_div) {
      info_div.childNodes.forEach(child => child.hidden = true);
      versions_div.querySelectorAll('.selected').forEach(button => button.classList.remove('selected'));
      event.target.classList.add('selected');
      show_info_div.hidden = false;
      return;
    }
    

    let org_innerHTML = event.target.innerHTML;
    event.target.innerHTML = 'Načítavam...';
    event.target.disabled = true;
    
    let url = event.target.getAttribute('url');
      
    fetch(url, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      }
    })
    .then(response => {
      if (response.ok) {
        return response.text();
      } else {
        throw new Error("Request failed with status " + response.status);
      }
    })
    .then(data => {
      info_div.childNodes.forEach(child => child.hidden = true);
      info_div.insertAdjacentHTML('beforeend', data);
      versions_div.querySelectorAll('.selected').forEach(button => button.classList.remove('selected'));
      event.target.classList.add('selected');
      event.target.innerHTML = org_innerHTML;
      event.target.disabled = false;
    })
    .catch(error => {
      event.target.innerHTML = 'Chyba serveru';
      console.log(error)
      return;
    })
  }
  </script>